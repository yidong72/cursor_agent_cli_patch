#!/bin/bash
# Patch cursor-agent to enable 'Run Everything' option
# This bypasses the team admin restriction on --force flag

set -e

CURSOR_AGENT_DIR="$HOME/.local/share/cursor-agent/versions"

# Find the latest version directory
if [ ! -d "$CURSOR_AGENT_DIR" ]; then
    echo "Error: cursor-agent versions directory not found at $CURSOR_AGENT_DIR"
    exit 1
fi

# Get all version directories and find the most recent one
LATEST_VERSION=$(ls -t "$CURSOR_AGENT_DIR" 2>/dev/null | head -1)

if [ -z "$LATEST_VERSION" ]; then
    echo "Error: No cursor-agent versions found"
    exit 1
fi

INDEX_JS="$CURSOR_AGENT_DIR/$LATEST_VERSION/index.js"

if [ ! -f "$INDEX_JS" ]; then
    echo "Error: index.js not found at $INDEX_JS"
    exit 1
fi

echo "Found cursor-agent version: $LATEST_VERSION"
echo "Target file: $INDEX_JS"

# Check if already patched
if grep -q "enableRunEverything = true" "$INDEX_JS"; then
    echo "Already patched! enableRunEverything is already set to true."
    exit 0
fi

# Check if the pattern exists
if ! grep -q "enableRunEverything = false" "$INDEX_JS"; then
    echo "Warning: Pattern 'enableRunEverything = false' not found."
    echo "The file structure may have changed in this version."
    exit 1
fi

# Create backup
BACKUP_FILE="$INDEX_JS.bak"
if [ ! -f "$BACKUP_FILE" ]; then
    echo "Creating backup at $BACKUP_FILE"
    cp "$INDEX_JS" "$BACKUP_FILE"
else
    echo "Backup already exists at $BACKUP_FILE"
fi

# Apply patch
echo "Applying patch..."
sed -i 's/enableRunEverything = false/enableRunEverything = true/g' "$INDEX_JS"

# Verify patch
if grep -q "enableRunEverything = true" "$INDEX_JS"; then
    echo "Patch applied successfully!"
    echo ""
    echo "You can now use: agent -f -p 'your prompt'"
else
    echo "Error: Patch verification failed"
    echo "Restoring from backup..."
    cp "$BACKUP_FILE" "$INDEX_JS"
    exit 1
fi
